import{e,I as O}from"./index-DHqL_ZfZ.js";import{B as $,M as j,s as A,a as V}from"./index-CQ5UfyT6.js";import q from"https://esm.sh/jspdf";import _ from"https://esm.sh/jspdf-autotable";function G({supplier:r,transactions:T=[],onDeleteTransaction:N,onEditTransaction:c,onOpenPdf:o,onOpenConfig:S,onNewMovement:R}){const x=r.providerType==="stock",b=(l,a)=>{const I=l.dateObj.getTime(),w=a.dateObj.getTime();if(I!==w)return I-w;const v=l.createdAt?.seconds?l.createdAt.seconds:0,C=a.createdAt?.seconds?a.createdAt.seconds:0;return v!==C?v-C:(l.id||"").localeCompare(a.id||"")},s=[...T.map(l=>({...l,dateObj:l.date?.seconds?new Date(l.date.seconds*1e3):new Date(l.date)}))].sort(b);let p=[];if(x)p=s;else{const l=parseFloat(r.balance||0),a=s.reduce((v,C)=>{const E=parseFloat(C.amount||0);return C.type==="invoice"?v+E:v-E},0);let w=l-a;p=s.map(v=>{const C=parseFloat(v.amount||0);return v.type==="invoice"?w+=C:w-=C,{...v,snapshotBalance:w}})}const d=[...p].sort((l,a)=>b(a,l));let i="",f="",n="";if(x){const l=r.stockDebt||{},a=Object.entries(l).filter(([I,w])=>w>0);a.length===0?(i="Sin deuda",f="color-pay",n="Estado"):(i=a.map(([I,w])=>`${w} ${I}`).join(" | "),f="color-stock",n="Stock Pendiente")}else{const l=parseFloat(r.balance||0);i=new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(l),l>10?(f="color-debt",n="Deuda Total"):l<-10?(f="color-pay",n="Saldo a Favor"):(f="color-pay",n="Cuenta al dÃ­a")}let m=!0;const k=e("span",{className:`sh-amount ${f}`},i),L=e("button",{className:"toggle-balance-btn",title:"Mostrar/Ocultar saldo"},O("eye")),t=e("button",{className:"card-action-btn btn-secondary",onclick:S},O("settings"),e("span",{},"Config")),u=e("button",{className:"card-action-btn btn-secondary",onclick:o},O("fileText"),e("span",{},"Ver PDF")),g=e("button",{className:"card-action-btn btn-primary",onclick:R},O("plus"),e("span",{},"Nuevo")),y=e("div",{className:"card-actions-row"},u,t,g),F=e("div",{className:"supplier-header-card"},e("div",{className:"card-top-row"},e("div",{className:"header-left"},e("div",{className:"sh-name"},r.name),r.alias?e("div",{className:"sh-alias-badge",onclick:()=>{navigator.clipboard.writeText(r.alias),alert("Alias copiado")}},O("copy")," "+r.alias):null),e("div",{className:"header-right"},e("span",{className:"sh-label"},n),e("div",{className:"balance-wrapper"},k,L))),e("div",{className:"card-divider"}),y);let B;if(d.length===0)B=e("div",{className:"empty-history"},"No hay movimientos registrados.");else{const l=d.map(a=>{const I=a.dateObj.getDate(),w=a.dateObj.toLocaleDateString("es-AR",{month:"short"}).toUpperCase().replace(".","");let v="",C="",E="",P="",H=null;if(x){const W=(a.items||[]).map(M=>`${M.quantity} ${M.name}`).join(", ");v=(a.type==="invoice"?"+ ":"- ")+W,C="color-stock",E="border-l-stock",P=a.type==="invoice"?"Entrada":"Salida"}else{const W=parseFloat(a.amount),M=new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"});if(v=M.format(W),a.type==="invoice"?(P=a.invoiceNumber?`Boleta #${a.invoiceNumber}`:"Boleta",v="+ "+v,C="color-debt",E="border-l-debt"):(P=a.type==="payment"?"Pago":"Nota CrÃ©dito",v="- "+v,C="color-pay",E="border-l-pay"),a.snapshotBalance!==void 0){const U=M.format(a.snapshotBalance),Y=a.snapshotBalance>5?"#dc2626":"#16a34a";H=e("div",{className:"sensitive-data",style:`font-size: 0.75rem; color: ${Y}; margin-top: 4px; font-weight: 600; text-align: right;`},`Saldo: ${U}`)}}return e("div",{className:`trans-card ${E}`,onclick:()=>c(a)},e("div",{className:"trans-date-box"},e("span",{className:"td-day"},I),e("span",{className:"td-month"},w)),e("div",{className:"trans-info"},e("span",{className:"ti-desc"},P),e("span",{className:"ti-meta"},a.description||a.dateObj.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),e("div",{className:"trans-amounts-col"},e("div",{className:`trans-amount ${C} sensitive-data`},v),H))});B=e("div",{className:"transaction-list"},...l)}const D=e("div",{className:"detail-container"},F,e("h3",{style:{fontSize:"1rem",color:"#666",margin:"10px 0 5px 5px"}},"Historial de Cuenta"),B);return L.onclick=()=>{m=!m,k.textContent=m?i:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",m?k.className=`sh-amount ${f}`:k.className="sh-amount amount-hidden",L.innerHTML="",L.appendChild(O(m?"eye":"eyeOff")),D.querySelectorAll(".sensitive-data").forEach(a=>{m?(a.dataset.realValue&&(a.textContent=a.dataset.realValue),a.classList.remove("amount-hidden-text")):(a.dataset.realValue||(a.dataset.realValue=a.textContent),a.textContent="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",a.classList.add("amount-hidden-text"))})},D}function K({supplier:r,onUpdate:T}){let N=[...r.defaultItems||[]],c=r.providerType||"money";const o=e("input",{value:r.name,placeholder:"Nombre del negocio"}),S=e("input",{value:r.alias||"",placeholder:"Alias / CBU / Nota"}),R=e("select",{},e("option",{value:"money"},"ðŸ’° Monetario (Solo Plata)"),e("option",{value:"stock"},"ðŸ“¦ MercaderÃ­a (Control de Stock)"));R.value=c;const x=e("div",{style:{display:"flex",flexDirection:"column",gap:"8px",marginTop:"10px"}}),b=()=>{x.innerHTML="",N.forEach((n,m)=>{const k=e("div",{style:{display:"flex",gap:"8px",alignItems:"center"}},e("input",{value:n,readOnly:!0,style:{background:"#f1f5f9",border:"1px solid #e2e8f0",flex:"1"}}),e("button",{className:"btn-icon btn-delete",type:"button",title:"Quitar Ã­tem",onClick:()=>{N.splice(m,1),b()}},O("trash")));x.appendChild(k)})},h=e("input",{placeholder:"Nuevo producto (Ej: Hielo 10kg)"}),s=$({text:"Agregar",variant:"secondary",onClick:()=>{const n=h.value.trim();n&&(N.push(n),h.value="",b(),h.focus())}}),p=e("div",{id:"catalog-section",style:{display:c==="stock"?"block":"none",borderTop:"1px solid #e2e8f0",marginTop:"15px",paddingTop:"15px"}},e("label",{style:{fontWeight:"600",marginBottom:"8px",display:"block"}},"CatÃ¡logo de Productos Habituales"),e("div",{style:{display:"flex",gap:"8px",marginBottom:"10px"}},h,s),x);R.onchange=n=>{c=n.target.value,p.style.display=c==="stock"?"block":"none"},b();let d=null;const i=async()=>{const n=o.value.trim();if(!n)return alert("El nombre es obligatorio");try{await A.updateSupplier(r.id,{name:n,alias:S.value.trim(),providerType:c,defaultItems:N}),T&&T(),d.close(),alert("ConfiguraciÃ³n guardada")}catch(m){alert("Error: "+m.message)}},f=e("div",{style:{display:"flex",flexDirection:"column",gap:"15px"}},e("div",{},e("label",{style:{fontWeight:"600"}},"Nombre"),o),e("div",{},e("label",{style:{fontWeight:"600"}},"Alias / Datos"),S),e("div",{},e("label",{style:{fontWeight:"600"}},"Tipo de Proveedor"),R),p);return d=j({title:"âš™ï¸ ConfiguraciÃ³n de Proveedor",content:f,footer:e("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px"}},$({text:"Cancelar",variant:"secondary",onClick:()=>d.close()}),$({text:"Guardar Cambios",onClick:i}))}),d}const z={generateAccountStatement(r,T,N,c){const o=new q,S=r.providerType==="stock",R=new Date().toLocaleDateString("es-AR"),x=t=>t?t.seconds?new Date(t.seconds*1e3):new Date(t):new Date,b=N?new Date(N+"T00:00:00"):null,h=c?new Date(c+"T23:59:59"):null,s=[...T].sort((t,u)=>x(t.date).getTime()-x(u.date).getTime());let p=0;if(!S){const t=parseFloat(r.balance||0),u=s.reduce((g,y)=>{const F=parseFloat(y.amount||0);return y.type==="invoice"?g+F:g-F},0);p=t-u,p=Math.round(p*100)/100}let d=p;const i=[];s.forEach(t=>{const u=x(t.date);let g=0;if(!S){const y=parseFloat(t.amount||0);g=t.type==="invoice"?y:-y}b&&u<b?d+=g:(!h||u<=h)&&i.push(t)}),o.setFontSize(16),o.setFont("helvetica","bold"),o.text(r.name.toUpperCase(),14,15),o.setFontSize(9),o.setFont("helvetica","normal"),o.setTextColor(100);let f=`Historial completo al ${R}`;if(b&&h&&(f=`PerÃ­odo: ${b.toLocaleDateString("es-AR")} al ${h.toLocaleDateString("es-AR")}`),o.text(f,14,20),!S){o.setFontSize(12),o.setTextColor(0);const t=new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(r.balance||0);o.text(`SALDO ACTUAL: ${t}`,196,15,{align:"right"})}let n=d;const m=[],k=!S&&(b||Math.abs(p)>1);if(k&&m.push([b?b.toLocaleDateString("es-AR"):"-","SALDO ANTERIOR / INICIAL","",new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(n)]),i.forEach(t=>{const g=x(t.date).toLocaleDateString("es-AR",{day:"2-digit",month:"2-digit",year:"2-digit"});let y=t.description||"",F="",B="";if(y||(t.type==="invoice"?y="Boleta / Compra":t.type==="payment"?y="Pago":y="Nota de CrÃ©dito"),S){const D=(t.items||[]).map(l=>`${l.quantity} ${l.name}`).join(", ");F=t.type==="invoice"?`+ ${D}`:`- ${D}`,B="-"}else{const D=parseFloat(t.amount||0);t.type==="invoice"?(n+=D,F=new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(D)):(n-=D,F="- "+new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(D)),B=new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(n)}m.push([g,y,F,B])}),_(o,{startY:25,head:[["FECHA","DETALLE","MONTO","SALDO"]],body:m,theme:"grid",styles:{fontSize:9,cellPadding:2,valign:"middle",lineWidth:.1,lineColor:[200,200,200]},headStyles:{fillColor:[50,50,50],textColor:255,fontStyle:"bold"},columnStyles:{0:{cellWidth:20},1:{cellWidth:"auto"},2:{halign:"right",fontStyle:"bold",cellWidth:35},3:{halign:"right",cellWidth:35}},didParseCell:function(t){if(t.section==="body"){let u=t.row.index;if(k){if(u===0){t.cell.styles.fontStyle="bold",t.cell.styles.fillColor=[240,240,240];return}u=u-1}const g=i[u];if(!g)return;g.type==="invoice"?t.cell.styles.fillColor=[255,245,245]:g.type==="payment"?t.cell.styles.fillColor=[240,253,244]:g.type==="credit_note"&&(t.cell.styles.fillColor=[240,255,230]),t.column.index===2&&(g.type==="invoice"?t.cell.styles.textColor=[220,38,38]:t.cell.styles.textColor=[22,163,74])}}}),S){const t=o.lastAutoTable.finalY+8;o.setFontSize(9),o.setFont("helvetica","bold"),o.text("STOCK PENDIENTE:",14,t);const u=r.stockDebt||{},g=Object.keys(u).filter(y=>u[y]>0).map(y=>`${u[y]}x ${y}`).join("  |  ");o.setFont("helvetica","normal"),o.text(g||"Sin deuda",14,t+5)}const L=o.output("bloburl");window.open(L,"_blank")}};function ee({navigateTo:r,params:T}){const N=e("div",{className:"supplier-detail-view",style:{padding:"20px",maxWidth:"800px",margin:"0 auto"}});if(!T||!T.supplier)return e("div",{},"Error: No se especificÃ³ el proveedor.");let c=T.supplier;const o=e("div",{},"Cargando historial..."),S=()=>{K({supplier:c,onUpdate:async()=>{await h()}}).open()},R=()=>{let s=null;const p=V({suppliers:[],preSelectedSupplier:c,onSubmit:async d=>{try{await A.registerMovement(d),s&&s.close(),await h()}catch(i){console.error(i),alert("Error: "+i.message)}},onCancel:()=>{s&&s.close()}});s=j({title:"Nuevo Movimiento",content:p}),s.open()},x=()=>{const s=new Date,p=new Date(s.getFullYear(),s.getMonth(),1).toISOString().split("T")[0],d=s.toISOString().split("T")[0],i=e("input",{type:"date",value:p,className:"modern-input",style:{width:"100%",padding:"8px",borderRadius:"8px",border:"1px solid #ddd"}}),f=e("input",{type:"date",value:d,className:"modern-input",style:{width:"100%",padding:"8px",borderRadius:"8px",border:"1px solid #ddd"}});let n=null;n=j({title:"ðŸ“„ Reporte PDF",content:e("div",{style:{display:"flex",flexDirection:"column",gap:"15px"}},e("div",{},e("label",{style:{fontWeight:"600",display:"block",marginBottom:"5px"}},"Desde:"),i),e("div",{},e("label",{style:{fontWeight:"600",display:"block",marginBottom:"5px"}},"Hasta:"),f),e("p",{style:{fontSize:"0.85rem",color:"#666",marginTop:"5px"}},"Incluye saldo anterior calculado.")),footer:e("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px",width:"100%"}},$({text:"Historial Completo",variant:"secondary",onClick:async()=>{const m=await A.getTransactions(c.id);z.generateAccountStatement(c,m,null,null),n.close()}}),$({text:"Descargar Reporte",variant:"primary",onClick:async()=>{const m=await A.getTransactions(c.id);z.generateAccountStatement(c,m,i.value,f.value),n.close()}}))}),n.open()},b=e("div",{style:{marginBottom:"15px",display:"flex",alignItems:"center"}},$({text:"â¬… Volver",variant:"secondary",onClick:()=>r("suppliers")})),h=async()=>{try{if(typeof A.getSupplierById=="function"){const d=await A.getSupplierById(c.id);d&&(c=d)}const s=await A.getTransactions(c.id),p=G({supplier:c,transactions:s,onEditTransaction:d=>{let i=null;const f=V({suppliers:[],preSelectedSupplier:c,initialValues:d,onSubmit:async n=>{A.updateTransaction?(await A.updateTransaction(d,n),i.close(),await h()):alert("EdiciÃ³n no implementada en servicio.")},onDelete:async()=>{confirm("Â¿EstÃ¡s seguro de eliminar este movimiento permanentemente?")&&(await A.deleteTransaction(d.id),i.close(),await h())},onCancel:()=>i.close()});i=j({title:"Editar Movimiento",content:f}),i.open()},onDeleteTransaction:async d=>{},onOpenPdf:x,onOpenConfig:S,onNewMovement:R});o.innerHTML="",o.appendChild(p)}catch(s){console.error(s),o.innerHTML=`<div style="color:red; padding: 20px;">Error cargando datos: ${s.message}</div>`}};return N.appendChild(b),N.appendChild(o),h(),N}export{ee as SupplierDetailView};
